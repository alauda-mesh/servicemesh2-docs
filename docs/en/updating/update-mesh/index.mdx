---
weight: 10
---

# Updating Alauda Service Mesh

The strategy you use to deploy a service mesh affects how you can update the mesh.

## Understanding versioning

Alauda Service Mesh follows Semantic Versioning for all product releases. Semantic Versioning uses a three-part version number in the format X.Y.Z to communicate the nature of changes in each release.

- **X (Major version)**: indicates significant updates that might include breaking changes, such as architectural shifts, API changes, or schema modifications.
- **Y (Minor version)**: introduces new features and enhancements while maintaining backward compatibility.
- **Z (Patch version or z-stream release)**: delivers critical bug fixes and security updates, such as Common Vulnerabilities and Exposures (CVEs) resolutions. Patch versions do not include new features.

## Understanding Service Mesh and Istio versions

The Alauda Service Mesh Operator includes additional Istio releases for upgrades but supports only the latest Istio version available for each Operator version.

## Understanding Operator updates and channels

The Operator Lifecycle Manager (OLM) manages Operators and their associated services by using channels to organize and distribute updates. Channels are a way to group related updates.

To ensure that your Alauda Service Mesh stays current with the latest security patches, bug fixes, and software updates, keep the Alauda Service Mesh Operator up to date. The upgrade process depends on the configured channel and approval strategy.

OLM provides the following channels for the Alauda Service Mesh Operator:

- **Latest** channel: tracks the most recent version of the Alauda Service Mesh 2 Operator and the latest supported version of Istio. This channel enables upgrades to new operator versions and corresponding Istio updates as soon as they are released. Use the `latest` channel to stay current with the latest features, bug fixes, and security updates.
- **Versioned** channel: restricts updates to patch-level releases within a specific minor version. For example, `servicemesh-2.0` provides access to the latest `2.0.8` patch version. When a new patch release becomes available, you can upgrade the Operator to the newer patch version. To move to a newer minor release, you must manually switch to a different channel. You can use a versioned channel to maintain a consistent minor version while applying only patch updates.

### About Operator update process

Operator Lifecycle Manager (OLM) will generate an update request, which a cluster administrator must approve to update the Operator to the latest version.

The Operator update process does not automatically update the Istio control plane unless the `Istio` resource version is set to an alias (for example, `vX.Y-latest`) and the `updateStrategy` is set to `InPlace`.

This triggers a control plane update when a new version is available in the Operator. By default, the Operator will not update the Istio control plane unless the `Istio` resource is updated with a new version.

## About Istio update process

After updating the Alauda Service Mesh 2 Operator, update the Istio control plane to the latest supported version. The `Istio` resource configuration determines how the control plane upgrade is performed, including which steps require manual action and which are handled automatically.

The `Istio` resource configuration includes the following fields that are relevant to the upgrade process:

- `spec.version`

  specifies the version of Istio to install. Use the format `vX.Y.Z`, where `X.Y.Z` is the desired Istio release.
  For example, set the field to `v1.24.6` to install Istio `1.24.6`.
  Alternatively, set the value to an alias such as `vX.Y-latest` to automatically install the latest supported patch version for the specified minor release.

- `spec.updateStrategy`

  defines the strategy for updating the Istio control plane. The available update strategies are `InPlace` and `RevisionBased`.

### About Istio control plane update strategies

The update strategy affects how the update process is performed. The `spec.updateStrategy` field in the `Istio` resource configuration determines how the Alauda Service Mesh 2 Operator updates the Istio control plane. When the Operator detects a change in the `spec.version` field or identifies a new minor release with a configured `vX.Y-latest` alias, it initiates an upgrade procedure. For each mesh, you select one of two strategies:

- `InPlace`
- `RevisionBased`

`InPlace` is the default strategy for updating Alauda Service Mesh.

## About InPlace strategy

The `InPlace` update strategy runs only one revision of the control plane at a time. During an update, all the workloads immediately connect to the new control plane version. To maintain compatibility between the sidecars and the control plane, you can upgrade only one minor version at a time.

The `InPlace` strategy updates and restarts the existing Istio control plane in place. During this process, only one instance of the control plane exists, eliminating the need to move workloads to a new control plane instance. To complete the update, restart the application workloads and gateways to refresh the Envoy proxies.

While the `InPlace` strategy offers simplicity and efficiency, thereâ€™s a slight possibility of application traffic interruption if a workload pod updates, restarts, or scales while the control plane is restarting. You can mitigate this risk by running multiple replicas of the Istio control plane (istiod).

### Selecting InPlace strategy

To select the `InPlace` strategy, set the `spec.updateStrategy.type` value in the Istio resource to `InPlace`.

**Example specification to select InPlace update strategy**

```yaml
kind: Istio
spec:
  updateStrategy:
    type: InPlace
```

You can set this value while creating the resource or edit it later. If you edit the resource after creation, make the change before updating the Istio control plane.

### Installing with InPlace update strategy

You can install the Istio control plane, Istio CNI, and the Bookinfo demo application using the `InPlace` update strategy.

:::note
You can use the following section to understand the update process. You can skip this installation if the cluster already includes an Istio deployment.
:::

**Procedure**

1. Create the `istio-system` namespace by running the following command:

   ```bash
   kubectl create ns istio-system
   ```

2. Attach the workloads to a control plane deployed using the `InPlace` strategy:

   1. Label the namespace to automatically include all workloads by entering the following command:

      ```bash
      kubectl label namespace <namespace_name> istio.io/rev=<revision_name>
      ```

   2. Apply the revision label to individual workloads by modifying the pod template in the `Deployment` resource. For example:

      ```yaml
      apiVersion: apps/v1
      kind: Deployment
      spec:
        template:
          metadata:
            labels:
              istio.io/rev: <revision_name>
      ```

3. If the revision name is `default`, attach the workloads to the revision by running the following command. The following example labels the namespace with `istio-injection: enabled` label.

   ```bash
   kubectl label namespace <namespace_name> istio-injection=enabled
   ```

4. Deploy the Istio control plane using the `InPlace` update strategy. The following example configuration creates an `Istio` resource named `default` in the `istio-system` namespace:

   **Example configuration**

   ```yaml
   apiVersion: sailoperator.io/v1
   kind: Istio
   metadata:
     name: default
   spec:
     namespace: istio-system
     version: v1.24.6
     updateStrategy:
       type: InPlace
   ```

5. *Optional*: Install the Istio CNI plugin with the desired version. The following example configuration creates an `IstioCNI` resource named default in the `istio-cni` namespace:

   ```yaml
   apiVersion: sailoperator.io/v1
   kind: IstioCNI
   metadata:
     name: default
   spec:
     version: v1.24.6
     namespace: istio-cni
   ```

### Updating Istio control plane with InPlace strategy

When updating Istio using the `InPlace` strategy, you can increment the version by only one minor release at a time. To update by more than one minor version, you must increment the version and restart the workloads after each update. Restarting workloads ensures compatibility between the sidecar and control plane versions. The update process is complete after restarting all workloads.

**Prerequisites**

- You are logged in to the Alauda Container Platform web console as cluster-admin.
- You have installed the Alauda Service Mesh 2 Operator, and deployed Istio.
- You have installed `istioctl` on your local machine.
- You have configured the Istio control plane to use the `InPlace` update strategy. In this example, the `Istio` resource named `default` is deployed in the `istio-system` namespace.
- *Optional*: You have installed the Istio CNI plugin with the desired version. In this example, the `IstioCNI` resource named `default` is deployed in the `istio-cni` namespace.
- You have labeled the `bookinfo` namespace to enable sidecar injection.
- You have application workloads running in the cluster. In this example, the bookinfo application is deployed in the `bookinfo` namespace.

**Procedure**

1. Change the version in the `Istio` resource. For example, to update to Istio `1.24.6`, set the spec.version field to `v1.24.6` by running the following command:

   ```bash
   kubectl patch istio default --type='merge' -p '{"spec":{"version":"v1.24.6"}}'
   ```

   **Version update in Istio CR**

   ```yaml
   kind: Istio
   spec:
     version: v1.24.6
     updateStrategy:
       type: InPlace
   ```

   The Service Mesh Operator deploys a new version of the control plane that replaces the old version of the control plane. The sidecars automatically reconnect to the new control plane.

2. Confirm that the new version of the control plane is ready by running the following command:

   ```bash
   kubectl get istio
   ```

   **Example output**

   ```
   NAME      REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
   default   1           1       1        default           Healthy   v1.24.6   8m10s
   ```

3. Restart the application workloads so that the new version of the sidecar gets injected by running the following command:

   ```bash
   kubectl rollout restart deployment -n bookinfo
   ```

**Verification**

Verify that the new version of the sidecar is running by entering the following command:

```bash
istioctl proxy-status
```

**Example output**

```
NAME                                                    CLUSTER        CDS                LDS                EDS                RDS                ECDS        ISTIOD                                     VERSION
details-v1-7d775cb4f6-5t9zm.bookinfo                    Kubernetes     SYNCED (2m25s)     SYNCED (2m25s)     SYNCED (2m17s)     SYNCED (2m25s)     IGNORED     istiod-default-v1-24-6-c98fd9675-r7bfw     1.24.6
productpage-v1-7c4b6b857-mxrw6.bookinfo                 Kubernetes     SYNCED (2m35s)     SYNCED (2m35s)     SYNCED (2m17s)     SYNCED (2m35s)     IGNORED     istiod-default-v1-24-6-c98fd9675-r7bfw     1.24.6
ratings-v1-5b896f8544-r552l.bookinfo                    Kubernetes     SYNCED (2m21s)     SYNCED (2m21s)     SYNCED (2m17s)     SYNCED (2m21s)     IGNORED     istiod-default-v1-24-6-c98fd9675-r7bfw     1.24.6
reviews-v1-746f96c9d4-9pw8k.bookinfo                    Kubernetes     SYNCED (2m17s)     SYNCED (2m17s)     SYNCED (2m17s)     SYNCED (2m17s)     IGNORED     istiod-default-v1-24-6-c98fd9675-r7bfw     1.24.6
reviews-v2-97bdf5876-4mzx5.bookinfo                     Kubernetes     SYNCED (2m35s)     SYNCED (2m35s)     SYNCED (2m17s)     SYNCED (2m35s)     IGNORED     istiod-default-v1-24-6-c98fd9675-r7bfw     1.24.6
reviews-v3-77d9db6844-djgjk.bookinfo                    Kubernetes     SYNCED (2m19s)     SYNCED (2m19s)     SYNCED (2m17s)     SYNCED (2m19s)     IGNORED     istiod-default-v1-24-6-c98fd9675-r7bfw     1.24.6
```

The column `VERSION` should match with the new control plane version.

## About RevisionBased strategy

The `RevisionBased` strategy runs two revisions of the control plane during an upgrade. This approach supports gradual workload migration from the old control plane to the new one, enabling canary upgrades. It also supports upgrades across more than one minor version.

The `RevisionBased` strategy creates a new Istio control plane instance for each change to the `spec.version` field. The existing control plane remains active until all workloads transition to the new instance. You can move the workloads to the new control plane by updating the `istio.io/rev` labels or using the `IstioRevisionTag` resource, followed by a restart.

Although the `RevisionBased` strategy involves additional steps and requires multiple control plane instances to run concurrently during the upgrade, it allows for gradual migration of workloads. This approach enables validation of the updated control plane with a subset of workloads before migrating the rest, making it useful for large meshes with mission-critical workloads.

### Selecting RevisionBased strategy

To deploy Istio with the `RevisionBased` strategy, create the `Istio` resource with the following `spec.updateStrategy` value:

**Example specification to select `RevisionBased` strategy**

```yaml
kind: Istio
spec:
  version: v1.24.6
  updateStrategy:
    type: RevisionBased
```

After you select the strategy for the Istio resource, the Operator creates a new `IstioRevision` resource with the name `<istio_resource_name>-<version>`.

### Installing Istio with RevisionBased strategy

You can install the Istio control plane, Istio CNI, and the Bookinfo demo application using the `RevisionBased` update strategy.

:::note
You can use the following section to understand the update process. You can skip this installation if the cluster already includes an Istio deployment.
:::

**Procedure**

1. Create the `istio-system` namespace by running the following command:

   ```bash
   kubectl create ns istio-system
   ```

2. Deploy the Istio control plane using the `RevisionBased` update strategy. The following example configuration creates an `Istio` resource named `default` in the `istio-system` namespace:

   **Example configuration**

   ```yaml
   apiVersion: sailoperator.io/v1
   kind: Istio
   metadata:
     name: default
   spec:
     namespace: istio-system
     version: v1.24.6
     updateStrategy:
       type: RevisionBased
   ```

3. *Optional*: Install the Istio CNI plugin with the desired version. The following example configuration creates an `IstioCNI` resource named default in the `istio-cni` namespace:

   ```yaml
   apiVersion: sailoperator.io/v1
   kind: IstioCNI
   metadata:
     name: default
   spec:
     version: v1.24.6
     namespace: istio-cni
   ```

4. Get the `IstioRevision` name by running the following command:

   ```bash
   kubectl get istiorevision -n istio-system
   ```

   **Example output**

   ```
   NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
   default-v1-24-6   Local   True    Healthy   False    v1.24.6   3m4s
   ```

### Updating Istio control plane with RevisionBased strategy

When updating Istio using the `RevisionBased` strategy, you can upgrade by more than one minor version at a time. The Alauda Service Mesh Operator creates a new `IstioRevision` resource for each change to the `.spec.version` field and deploys a corresponding control plane instance. To migrate workloads to the new control plane, set the `istio.io/rev` label on the namespace to match the name of the `IstioRevision` resource, and then restart the workloads.

**Prerequisites**

- You are logged in to the Alauda Container Platform web console as cluster-admin.
- You have installed the Alauda Service Mesh 2 Operator, and deployed Istio.
- You have installed `istioctl` on your local machine.
- You have configured the Istio control plane to use the `RevisionBased` update strategy. In this example, the `Istio` resource named `default` is deployed in the `istio-system` namespace.
- *Optional*: You have installed the Istio CNI plugin with the desired version. In this example, the `IstioCNI` resource named `default` is deployed in the `istio-cni` namespace.
- You have labeled the `bookinfo` namespace to enable sidecar injection.
- You have application workloads running in the cluster. In this example, the bookinfo application is deployed in the `bookinfo` namespace.

**Procedure**

1. Change the version in the `Istio` resource. For example, to update to Istio `1.24.6`, set the spec.version field to `v1.24.6` by running the following command:

   ```bash
   kubectl patch istio default --type='merge' -p '{"spec":{"version":"v1.24.6"}}'
   ```

   **Version update in Istio CR**

   ```yaml
   kind: Istio
   spec:
     version: v1.24.6
     updateStrategy:
       type: RevisionBased
   ```

   The Service Mesh Operator deploys a new version of the control plane alongside the old version of the control plane. The sidecars remain connected to the old control plane.

2. Confirm that both `Istio` and `IstioRevision` resources are ready with the new revision.

   1. Confirm that `Istio` resource is ready by running the following command:

      ```bash
      kubectl get istio
      ```

      **Example output**

      ```
      NAME      REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
      default   2           2       1        default-v1-2-6   Healthy   v1.24.6   9m23s
      ```

   2. Confirm that `IstioRevision` resource is ready by running the following command:

      ```bash
      kubectl get istiorevision
      ```

      **Example output**

      ```
      NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
      default-v1-24-5   Local   True    Healthy   True     v1.24.4   10m
      default-v1-24-6   Local   True    Healthy   False    v1.24.6   66s
      ```

3. Confirm that there are two control plane pods running, one for each revision by running the following command:

   ```bash
   kubectl get pods -n istio-system
   ```

   **Example output**

   ```
   NAME                                      READY   STATUS    RESTARTS   AGE
   istiod-default-v1-24-5-c98fd9675-r7bfw    1/1     Running   0          10m
   istiod-default-v1-24-6-7495cdc7bf-v8t4g   1/1     Running   0          113s
   ```

4. Confirm that the workload sidecars are still connected to the previous control plane by running the following command:

   ```bash
   istioctl proxy-status
   ```

   **Example output**

   ```
   NAME                                                    CLUSTER        CDS                LDS                EDS                RDS                ECDS        ISTIOD                                     VERSION
   details-v1-7d775cb4f6-5t9zm.bookinfo                    Kubernetes     SYNCED (2m25s)     SYNCED (2m25s)     SYNCED (2m17s)     SYNCED (2m25s)     IGNORED     istiod-default-v1-24-5-c98fd9675-r7bfw     1.24.5
   productpage-v1-7c4b6b857-mxrw6.bookinfo                 Kubernetes     SYNCED (2m35s)     SYNCED (2m35s)     SYNCED (2m17s)     SYNCED (2m35s)     IGNORED     istiod-default-v1-24-5-c98fd9675-r7bfw     1.24.5
   ratings-v1-5b896f8544-r552l.bookinfo                    Kubernetes     SYNCED (2m21s)     SYNCED (2m21s)     SYNCED (2m17s)     SYNCED (2m21s)     IGNORED     istiod-default-v1-24-5-c98fd9675-r7bfw     1.24.5
   reviews-v1-746f96c9d4-9pw8k.bookinfo                    Kubernetes     SYNCED (2m17s)     SYNCED (2m17s)     SYNCED (2m17s)     SYNCED (2m17s)     IGNORED     istiod-default-v1-24-5-c98fd9675-r7bfw     1.24.5
   reviews-v2-97bdf5876-4mzx5.bookinfo                     Kubernetes     SYNCED (2m35s)     SYNCED (2m35s)     SYNCED (2m17s)     SYNCED (2m35s)     IGNORED     istiod-default-v1-24-5-c98fd9675-r7bfw     1.24.5
   reviews-v3-77d9db6844-djgjk.bookinfo                    Kubernetes     SYNCED (2m19s)     SYNCED (2m19s)     SYNCED (2m17s)     SYNCED (2m19s)     IGNORED     istiod-default-v1-24-5-c98fd9675-r7bfw     1.24.5
   ```

   The `VERSION` column should match the old control plane version.

5. Move the workloads to the new control plane by updating the `istio.io/rev` label on the application namespace or pods to the revision name. For example, update the label for the entire namespace by running the following command:

   ```bash
   kubectl label namespace bookinfo istio.io/rev=<new_revision_name> --overwrite
   ```

6. Restart the application workloads so that the new version of the sidecar gets injected by running the following command:

   ```bash
   kubectl rollout restart deployment -n bookinfo
   ```

**Verification**

1. Verify that the new version of the sidecar is running by entering the following command:

   ```bash
   istioctl proxy-status
   ```

   The `VERSION` column should match the new control plane version.

2. Verify that the old control plane, `Istio`, and `IstioRevision` resources has been deleted.
   1. Verify that the old control plane has beend deleted by running the following command:
   2. Verify that the `Istio` resource has been deleted by running the following command:
      ```bash
      kubectl get istio
      ```
   3. Verify that the `IstioRevision` resource has been deleted by running the following command:
      ```bash
      kubectl get istiorevision
      ```

The Alauda Service Mesh Operator deletes the old `IstioRevision` resource and the associated control plane after the grace period defined in the `spec.updateStrategy.inactiveRevisionDeletionGracePeriodSeconds` field expires. The default grace period is `30` seconds.

You can increase the grace period to allow sufficient time to test the new control plane before removing the previous revision. Set a higher value during canary upgrades to ensure workload stability before fully transitioning.
